const db = require("../models");
const isAuthenticated = require("../config/isAuthenticated");
const auth = require("../config/auth");
const moment = require("moment");


// LOGIN ROUTE
module.exports = app => {

  app.post('/api/login', (req, res) => {
    auth
      .logUserIn(req.body.email, req.body.password)
      .then(dbUser => res.json(dbUser))
      .catch(err => res.status(400).json(err));
  });


  // Any route with isAuthenticated is protected and you need a valid token
  // to access
  app.get('/api/user/:id', isAuthenticated, (req, res) => {
    db.User.findById(req.params.id).then(data => {
      if (data) {
        res.json(data);
      } else {
        res.status(404).send({ success: false, message: 'No user found' });
      }
    }).catch(err => res.status(400).send(err));
  });

 // Any route with isAuthenticated is protected and you need a valid token
  // to access
  // app.get('/api/textDetail/', isAuthenticated, (req, res) => {
    app.get('/api/textDetail/', (req, res) => {

      db.Text.find({})
    // db.Text.find({_id: req.user.id})
    .then(data => {
        res.json(data);
    }).catch(err => res.status(400).send(err));
  });


  //just used to create dummy data for the demonstration
  app.post('/api/createdata/', (req, res) => {


    let passcode = 'sasparilla'  //passcode so no one creates dummy data accidentally

    if (req.body.passcode === 'sasparilla') {
      let user =
      {
        username: 'vernsair',
        email: 'bturksub@gmail.com',
        password: 'password',
        streetaddress: '123 West Elm Ln',
        city: 'San Diego',
        state: 'CA',
        zipCode: '87343'
      }

      let locations = [
        {
          locationName: 'Pacific',
          streetAddress: '14 Pacific Dr',
          city: 'La Jolla',
          state: 'CA',
          zipCode: '92037',
          phonenumber: '8585552323'
        },
        {
          locationName: 'Atlantic',
          streetAddress: '14 Atlantic Ave',
          city: 'El Cajon',
          state: 'CA',
          zipCode: '67047',
          phonenumber: '7603437766'
        },
        {
          locationName: 'West Elm',
          streetAddress: '120 West Elm St',
          city: 'La Jolla',
          state: 'CA',
          zipCode: '92037',
          phonenumber: '8585552323'
        },
        {
          locationName: 'Yankee',
          streetAddress: '30 Yankee Way',
          city: 'La Jolla',
          state: 'CA',
          zipCode: '92037',
          phonenumber: '8585552323'
        }
      ]


      db.User.findOne({
        email: 'bturksub@gmail.com'
      })
        .then(async data => {

          if (!data) {
            data = await createUser(user)
          }

          var goodComments = [
            "I loved my meal",
            "Great service",
            "I had a great time at your business.  Thank you",
            "My food tasted great",
            "Wow, I will make sure to come back again because the food was great",
            "The service was excellent. Really nice people work here",
            "Keep up the good work",
            "Thank you for a great experience.",
            "Well done.  The food was served quickly and tasted great"
          ]

          var badComments = [
            "I hated my meal",
            "Poor service",
            "I had a terrible time at your business.  Thank you for nothing",
            "My food tasted awful",
            "Wow, I will never come back again because the food was horrible",
            "The service was poor. Really rude people work here",
            "Please improve your service",
            "Thanks for nothing.",
            "Poorly done.  The food was served slowly and tasted terrible"
          ]

         



          //create locations with user id
          var id = data._id
          locations.forEach(item => {

            item.userid = id;
            db.Location.findOne({
              locationName: item.locationName,
              userid: id
            })
              .then(async data => {
                if (!data) { ///not found create
                  data = await createLocation(item)
                }
                else {  //update with correct user
                  data = await updateLocation(item)
                }


                //create texts 
                var numbers = []
                //create 1000 different phone numbers ranging from 555555555 to 999999999
                for (x = 0; x < 10000; x++) {
                  var digits = Math.floor(Math.random() * 9000000000) + 1000000000;
                  numbers.push(digits)

                }

                /*Two types of messages. 
                  2.  Inital send with rating
                  3.  Comment
                */


                var location = item
                var x = 0;
                for (x = 0; x < 1000; x++) {
                  //pick random location

                  var customer = numbers[Math.floor(Math.random() * numbers.length)]
                  var rating = Math.floor(Math.random() * 10) + 1

                  var firstDay = moment().subtract(31, 'days')
                  var lastDay = moment().subtract(1, 'days')
                  var daysBetween = lastDay.diff(firstDay, 'days')

                  var randomDay = Math.floor(Math.random() * daysBetween) + 1
                  var firstTime = firstDay.add(randomDay, 'days')
                  var firstTime = firstTime.add(Math.floor(Math.random() * 24), 'hours')
                  var firstTime = firstTime.add(Math.floor(Math.random() * 60), 'minutes')
                  var firstTime = firstTime.add(Math.floor(Math.random() * 60), 'seconds')

                  secondTime = moment(firstTime).add(Math.floor(Math.random() * 60),'minutes');

                  
                  var comment = ""
                  if (rating < 6) {
                    comment = badComments[Math.floor(Math.random() * badComments.length)]
                  } else {
                    comment = goodComments[Math.floor(Math.random() * goodComments.length)]
                  }


                  var text = {
                    customerPhonenumber: customer,
                    locationPhonenumber: location.phonenumber,
                    messages: [{
                      textBody: rating,
                      timeStamp: firstTime.format()
                    },
                    {
                      textBody: comment,
                      timeStamp: secondTime.format()
                    }],
                    reviewComplete: true,
                    reviewValid: true,
                    rating: rating,
                    userComment: comment,
                    userid: id,
                    createdAt: firstTime.format()
                  }

                  // console.log(data);
                  data = await createText(text)

                }
              })


          })
          res.json(data)
        })

    }
  })



  function createText(text) {
    return new Promise(async function (resolve, reject) {
      db.Text.create(text)
        .then(data => resolve(data))
        .catch(err => resolve(err))
    })
  }


  function createLocation(item) {
    return new Promise(async function (resolve, reject) {
      db.Location.create(item)
        .then(data => {
          db.User.findOneAndUpdate({_id: item.userid}, {"$push":{locations: data._id}}, { new: true })
            .then(data => resolve(data))
            .catch(err => resolve(err))
        })
        .catch(err => resolve(err))
    })
  }

  function updateLocation(item) {
    return new Promise(async function (resolve, reject) {
      db.Location.findOneAndUpdate({ locationName: item.locationName }, { userid: item.userid }, { new: true })
        .then(data => resolve(data))
        .catch(err => resolve(err))
    })
  }


  function createUser(user) {
    return new Promise(async function (resolve, reject) {
      db.User.create(user)
        .then(data => resolve(data))
        .catch(err => resolve(err))

    })
  }


}

import axios from 'axios';
import Location from './../utils/Location';

export default {

  // ROUTE FOR GETTING USER
  // TODO MODIFY ROUTE AND SERVER SIDE TO GET WITHOUT POPULATING LOCATIONS
  // -----------------------------------------------------------------------------------------
  // app.get("/api/user/:id", function(req, res) {
  getUser: (id) => {
    return axios.get(`/api/user/${id}`);
  },


  // SIGNUP ROUTE
  // -----------------------------------------------------------------------------------------
  // app.post('/api/signup', (req, res) => {
  signUpUser: (username, email, password, street, city, state, zip) => {
    return axios.post('api/signup', {
      username: username,
      email: email,
      password: password,
      street: street,
      city: city,
      state: state,
      zip: zip
    });
  },


  // ROUTE FOR GETTING A USER AND ALL ITS LOCATIONS
  // -----------------------------------------------------------------------------------------
  // app.get("/api/user/:id", function(req, res) {
  getLocations: (id) => {
    return axios.get(`api/user/${id}`);
  },


  // ROUTE FOR ADDING A LOCATION TO LOCATION COLLECTION AND ADDING ITS LINK TO USER
  // -----------------------------------------------------------------------------------------
  // app.post("/api/addlocation", function(req, res) {     
  addLocation: (newLocation) => {
    return axios.post(`api/addlocation`, newLocation)
  },

  //Get the texts for the detail page
  getDetail: () => {
    return axios.get('api/textDetail')
  }
}

import React, { Component } from "react";
import API from "../../utils/API";
// import "./index.css";
import ReactTable from 'react-table'
import "react-table/react-table.css";
import Moment from 'moment'
import withAuth from '../../components/withAuth';
// import DateRangePicker from "react-daterange-picker";
// import "react-daterange-picker/dist/css/react-calendar.css";
// import { extendMoment } from "moment-range";
// const moment = extendMoment(Moment);


class Detail extends Component {

  state = {
    columns: [{
      Header: 'Customer #',
      accessor: 'customerPhonenumber',
      Cell: row => <span>{this.formatPhoneNumber(row.value)}</span>,
      maxWidth: 130,
      style: { textAlign: 'right' },
      headerStyle: { textAlign: 'right' }

    },
    {
      Header: 'Rating',
      accessor: 'rating',
      maxWidth: 60,
      style: { textAlign: 'center' },
      headerStyle: { textAlign: 'center' },
      Cell: row => <span style={{ color: row.value < 5 ? 'red' : row.value > 5 ? 'green' : '' }}>{row.value}</span>
    },
    {
      Header: 'Comment',
      accessor: 'userComment',
      style: { textAlign: 'left' },
      headerStyle: { textAlign: 'left' }
    },
    {
      Header: 'Date/Time',
      accessor: 'createdAt',
      style: { textAlign: 'right' },
      headerStyle: { textAlign: 'right' },
      maxWidth: 130,
      Cell: row => <span>{Moment(row.value).format('M/D/YY h:mma')}</span>
    //   ,
    //   Filter: ({ filter, onChange }) =>
    //   <div>
    //   <DateRangeExample />
    //  </div>
    },
    {
      Header: 'Location #',
      accessor: 'locationPhonenumber',
      Cell: row => <span>{this.formatPhoneNumber(row.value)}</span>,
      maxWidth: 130,
      style: { textAlign: 'right' },
      headerStyle: { textAlign: 'right' }
    },
    {
      Header: "",
      expander: true,
      Cell: () => <strong>+</strong>,
      width: 35,
      Expander: ({ isExpanded, ...rest }) =>
        <div>
          {isExpanded
            ? <span>&#x2299;</span>
            : <span>&#x2295;</span>}
        </div>,
      style: {
        cursor: "pointer",
        fontSize: 25,
        padding: "0",
        textAlign: "center",
        userSelect: "none"
      }
    },
    {
      show: false,
      accessor: 'messages'
    }

    ]
    ,
    data: [],
    loadingText: false
  }

  formatPhoneNumber(phoneNumberString) {
    var cleaned = ('' + phoneNumberString).replace(/\D/g, '')
    var match = cleaned.match(/^(1|)?(\d{3})(\d{3})(\d{4})$/)
    if (match) {
      var intlCode = (match[1] ? '+1 ' : '')
      return [intlCode, '(', match[2], ') ', match[3], '-', match[4]].join('')
    }
    return null
  }


  componentDidMount() {
    console.log('here')
    this.setState({
      loading: true
    })
    API
      .getDetail()
      .then(res => {
        this.setState({
          data: res.data,
          loading: false
        })

        console.log(res.data)
        // if (res.data.length > 0) {
        //   //get list of location for filter dropdown
        //   var userid = res.data[0].userid
        //   API
        //     .getLocations(userid)
        //     .then(res => {
        //       console.log(res.data)
        //     })
        // }

      })

  }

  //   componentDidUpdate(prevProps) {


  //   }


  render() {
    return (
      <ReactTable
        data={this.state.data}
        columns={this.state.columns}
        sortable={true}
        multiSort={true}
        resizable={true}
        filterable={true}
        loading={this.state.loading}
        loadingText={'Loading...'}
        noDataText={'No rows found'}
        defaultSorted={[
          {
            id: "createdAt",
            desc: true
          }]}
        defaultPageSize={10}
        className="-striped -highlight"
        SubComponent={row =>
          <div style={{ padding: '10px' }}>
            Comment: <b>{row.row.userComment} </b><br />
            Comment Time: <b>{Moment(row.row.messages[1].timeStamp).format('M/D/YY h:mma')}</b>

          </div>}
      />
    )
  }
}

export default withAuth(Detail);

